# SDK Provider

## Overview

Integration with ISync is done through xml files shared with ISync via SFTP. For the integration service (upwards to ISync), this involves creating xml files in the relevant folder with ISync will then read. See the basic steps below. 

1. Transactions are sent to the integration service and are processed by one of the supported methods (see supported methods below)
2. The transactions are then mapped to the relevant xml file type and written to the `ISyncFilePath`/Outbound/`FileTypeName` folder as well as the to the `ArchiveFilePath`/Outbound/`FileTypeName`
3. ISync will then read from the folder and remove any integrated files. 

!!! Note
    The integration reference is the name of the xml file generated by the integration service. This file name is a GUID and will always be unique. 

## Database Table Logging

The sdk provider logs additional information to the custom table below. This table needs to be created on the Granite database. You can then create the Datagrid below that uses the table. 

``` sql
CREATE TABLE [dbo].[Custom_ISyncIntegrationLog](
	[ArchiveFilePath] [varchar](250) NULL,
	[IntegrationFilePath] [varchar](250) NULL,
	[IntegrationReference] [varchar](250) NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[TransactionIds] [varchar](1000) NULL
) ON [PRIMARY]
```

```sql
CREATE VIEW [dbo].[ISyncIntegrationUpwards]
AS
SELECT	ISIL.IntegrationReference, 
		ISNULL(Document.Number, '') Document,
		MasterItem.Code, 
		MasterItem.ERPIdentification,
		TR.Type,
		tr.ActionQty,
		ISIL.IntegrationFilePath,
		ISIL.ArchiveFilePath
FROM	Custom_ISyncIntegrationLog ISIL
		INNER JOIN [Transaction] TR ON TR.IntegrationReference = ISIL.IntegrationReference
		LEFT JOIN Document ON TR.Document_id = Document.ID
		LEFT JOIN DocumentDetail ON TR.DocumentLine_id = DocumentDetail.ID
		LEFT JOIN MasterItem ON TR.FromMasterItem_id = MasterItem.ID
```

```json
[
  {
    "field": "IntegrationReference",
    "width": 262,
    "filter": "agTextColumnFilter",
    "cellClassRules": {
      "bg-success": "x === x"
    }
  },
  {
    "field": "Document",
    "width": 117,
    "filter": "agTextColumnFilter"
  },
  {
    "field": "Code",
    "width": 128,
    "filter": "agTextColumnFilter"
  },
  {
    "field": "ERPIdentification",
    "width": 156,
    "filter": "agTextColumnFilter"
  },
  {
    "field": "Type",
    "width": 87,
    "filter": "agTextColumnFilter"
  },
  {
    "field": "ActionQty",
    "width": 118,
    "filter": "agTextColumnFilter"
  },
  {
    "field": "IntegrationFilePath",
    "width": 710,
    "filter": "agTextColumnFilter"
  },
  {
    "field": "ArchiveFilePath",
    "width": 750,
    "filter": "agTextColumnFilter"
  }
]
```



## Settings

!!! note 
    To pick up any changes to the SystemSettings table, the IntegrationService will need to be restarted.

The settings for ISync are configured in the SystemSettings table. The IntegrationService will pick up the settings using the Application name specified in it's `.config` file:
If this setting is missing from the config file or left empty, the IntegrationService will default to using `ISync` as the SystemSettingsApplicationName
You can browse the IntegrationService's `/config` page to have the IntegrationService create the default settings in the SystemSettings table for you.

### Config File Settings

```xml
    <add key="SystemSettingsApplicationName" value="ISync" />
    <add key="EndPoint" value="http://:40091/" />
```

### Database Settings 

| Key                        | Description                                      | Example Value                  | 
|----------------------------|--------------------------------------------------|--------------------------------| 
| ISyncFilePath              | File path for iSync files                        | "C:\iSyncDirectory"           | 
| ArchiveFilePath            | File path for archived files                     | "C:\ArchiveDirectory"         | 
| WarehouseName              | Name of the warehouse used for posting upwards   | "MainWarehouse"                | 
| ClientCode                 | Client code used as DepositorCode in XML documents | "Client123"                    |

<H4>ISyncFilePath</H4>

This is the base file path where files are used to integrate with ISync will be written. 

<H4>ArchiveFilePath</H4>

This folder is used to keep a backup of the files sent to ISync. 

<H4>WarehouseName</H4>

This is used to set the name of the Warehouse in ISync where the transactions will take place. This will have to be obtained from ISync.

<H4>ClientCode</H4>

This is used as the DepositorCode in the XML documents and is static for the customer. This will have to be obtained from ISync.


## Integration Methods

By default if the method name below is the same as a Granite Transaction type, it will autowire the integration.
If you require a different integration action you can specify the name below in the Process IntegrationMethod property.


### ADJUSTMENT

- Granite Transaction: **ADJUSTMENT**
- ISync Transaction Type: **Inventory Adjustment Advice**

- Returns
    - XML File Name 

InventoryAdjustmentAdvice Mapping 

| `Transaction` Property          | `InventoryAdjustmentAdvice` Property | Mapping Logic             |
|---------------------------------|--------------------------------------|-------------------------------------------|
| `transactions.FirstOrDefault().TransactionDocumentReference` | `AdjustmentNumber`    | Direct assignment from the first transaction's `TransactionDocumentReference` |
| `DateTime.Now`                  | `AdjustmentDate`                     | Current date and time     |
| `System Settings ClientCode`          | `DepositorCode`                      | Direct assignment from `System Settings ClientCode`       |
| `System Settings WarehouseName`       | `WarehouseName`                      | Direct assignment from `System Settings WarehouseName`    |
| `transactions.GroupBy(t => new { t.Code })` | `Items`  | Grouped by `Code` and mapped to `InventoryAdjustmentAdviceItem`    |

InventoryAdjustmentAdviceItem Mapping

| `Transaction` Property | `InventoryAdjustmentAdviceItem` Property | Mapping Logic                                                                 |
|------------------------|------------------------------------------|-------------------------------------------------------------------------------|
| `t.Code`               | `ProductCode`                            | Mapped using `graniteRepository.GetMasterItemErpIdentification(t.Code)`       |
| `t.Code`               | `UPC`                                    | Direct assignment from `t.Code`                                               |
| `t.ToQty - t.FromQty`  | `AdjustedQty`                            | Calculated as the difference between `ToQty` and `FromQty`                    |
| `t.UOM`                | `AdjustedQtyUOM`                         | Direct assignment from `t.UOM`                                                |


### STOCKTAKE

- Granite Transaction: **STOCKTAKE**
- ISync Transaction Type: **Inventory Adjustment Advice**

- Returns
    - XML File Name 

InventoryAdjustmentAdvice Mapping 

| `Transaction` Property          | `InventoryAdjustmentAdvice` Property | Mapping Logic             |
|---------------------------------|--------------------------------------|-------------------------------------------|
| `transactions.FirstOrDefault().TransactionDocumentReference` | `AdjustmentNumber`    | Direct assignment from the first transaction's `TransactionDocumentReference` |
| `DateTime.Now`                  | `AdjustmentDate`                     | Current date and time     |
| `System Settings ClientCode`          | `DepositorCode`                      | Direct assignment from `System Settings ClientCode`       |
| `System Settings WarehouseName`       | `WarehouseName`                      | Direct assignment from `System Settings WarehouseName`    |
| `transactions.GroupBy(t => new { t.Code })` | `Items`  | Grouped by `Code` and mapped to `InventoryAdjustmentAdviceItem`    |

InventoryAdjustmentAdviceItem Mapping

| `Transaction` Property | `InventoryAdjustmentAdviceItem` Property | Mapping Logic                                                                 |
|------------------------|------------------------------------------|-------------------------------------------------------------------------------|
| `t.Code`               | `ProductCode`                            | Mapped using `graniteRepository.GetMasterItemErpIdentification(t.Code)`       |
| `t.Code`               | `UPC`                                    | Direct assignment from `t.Code`                                               |
| `t.ToQty - t.FromQty`  | `AdjustedQty`                            | Calculated as the difference between `ToQty` and `FromQty`                    |
| `t.UOM`                | `AdjustedQtyUOM`                         | Direct assignment from `t.UOM`                                                |

### SCRAP

- Granite Transaction: **SCRAP**
- ISync Transaction Type: **Inventory Adjustment Advice**

- Returns
    - XML File Name 

InventoryAdjustmentAdvice Mapping

| `Transaction` Property          | `InventoryAdjustmentAdvice` Property | Mapping Logic              |
|---------------------------------|--------------------------------------|-------------------------------------|
| `transactions.FirstOrDefault().TransactionDocumentReference` | `AdjustmentNumber`     | Direct assignment from the first transaction's `TransactionDocumentReference` |
| `DateTime.Now`                  | `AdjustmentDate`                     | Current date and time          |
| `System Settings ClientCode`          | `DepositorCode`                      | Direct assignment from `System Settings ClientCode`   |
| `System Settings WarehouseName`       | `WarehouseName`                      | Direct assignment from `System Settings WarehouseName`|
| `transactions.GroupBy(t => new { t.Code })` | `Items` | Grouped by `Code` and mapped to `InventoryAdjustmentAdviceItem`              |

InventoryAdjustmentAdviceItem Mapping

| `Transaction` Property | `InventoryAdjustmentAdviceItem` Property | Mapping Logic                                                                 |
|------------------------|------------------------------------------|-------------------------------------------------------------------------------|
| `t.Code`               | `ProductCode`      | Mapped using `graniteRepository.GetMasterItemErpIdentification(t.Code)`       |
| `t.Code`               | `UPC`         | Direct assignment from `t.Code`   |
| `-t.ActionQty`         | `AdjustedQty`      | Negated value of `ActionQty`     |
| `t.UOM`                | `AdjustedQtyUOM`      | Direct assignment from `t.UOM`          |


### PICK

- Granite Transaction: **PICK**
- ISync Transaction Type: **Warehouse Shipment Advise**

- Returns
    - XML File Name 

WarehouseShipmentAdvise Mapping

| `Transaction` Property          | `WarehouseShipmentAdvise` Property | Mapping Logic         |
|---------------------------------|------------------------------------|----------------------------------|
| `System Settings ClientCode`          | `DepositorCode`                   | Direct assignment from `System Settings ClientCode`                                |
| `"Shipped"`                     | `ShipmentOrderStatus`             | Static string assignment                                                     |
| `transactions.FirstOrDefault().TransactionDocumentReference` | `ShipmentNumber`                  | Direct assignment from the first transaction's `TransactionDocumentReference` |
| `DateTime.Now`                  | `ShipDate`                        | Current date and time                                                        |
| `transactions.FirstOrDefault().Document` | `DepositorOrderNumber`             | Direct assignment from the first transaction's `Document`                    |
| `transactions.FirstOrDefault().Document` | `PurchaseOrderNumber`              | Direct assignment from the first transaction's `Document`                    |
| `"Shipped from Granite"`        | `TransportReference`              | Static string assignment                                                     |
| `graniteRepository.GetCarrierName(document)` | `CarrierName`                     | Mapped using `graniteRepository.GetCarrierName(document)`                    |
| `transactions.GroupBy(t => new { t.Code })` | `Items`                          | Grouped by `Code` and mapped to `WarehouseShipmentAdviseItem`                |

WarehouseShipmentAdviseItem Mapping

| `Transaction` Property | `WarehouseShipmentAdviseItem` Property | Mapping Logic                                                                 |
|------------------------|----------------------------------------|-------------------------------------------------------------------------------|
| `t.Code`               | `ProductCode`                          | Mapped using `graniteRepository.GetMasterItemErpIdentification(t.Code)`       |
| `t.Code`               | `UPC`                                  | Direct assignment from `t.Code`                                               |
| `graniteRepository.GetOrderQty(t.Code)` | `OrderedQty`                        | Mapped using `graniteRepository.GetOrderQty(t.Code)`            |
| `t.UOM`                | `OrderedQtyUOM`                        | Direct assignment from `t.UOM`                                                |
| `t.ActionQty`          | `ShippedQty`                           | Direct assignment from `ActionQty`                                            |
| `t.UOM`                | `ShippedQtyUOM`                        | Direct assignment from `t.UOM`                                                |
| `documentDetailErpId.Split('-').Last()` |`ShipmentOrderItemId`| Mapped using `graniteRepository.GetDocumentDetailErpId(t.LineNumber, t.Document, t.Code)` |




### RECEIVE

- Granite Transaction: **RECEIVE**
- ISync Transaction Type: **Inventory Receipt Advice**

- Returns
    - XML File Name 

InventoryReceiptAdvice Mapping

| `Transaction` Property          | `InventoryReceiptAdvice` Property | Mapping Logic                                                                 |
|---------------------------------|-----------------------------------|-------------------------------------------------------------------------------|
| `System Settings ClientCode`          | `DepositorCode`                  | Direct assignment from `System Settings ClientCode`                                |
| `transactions.FirstOrDefault().Document` | `DepositorOrderNumber`          | Direct assignment from the first transaction's `Document`                    |
| `transactions.FirstOrDefault().TransactionDocumentReference` | `WarehouseReceiptNumber`         | Direct assignment from the first transaction's `TransactionDocumentReference` |
| `DateTime.Now.ToString("yyyy-MM-dd")` | `ReceiptDate`                    | Current date formatted as `yyyy-MM-dd`                                       |
| `System Settings WarehouseName`       | `WarehouseName`                  | Direct assignment from `System Settings WarehouseName`                             |
| `"Received in Granite"`         | `Comments`                       | Static string assignment                                                     |
| `transactions.GroupBy(t => new { t.Code })` | `Items`                         | Grouped by `Code` and mapped to `InventoryReceiptItem`                       |

InventoryReceiptItem Mapping

| `Transaction` Property | `InventoryReceiptItem` Property | Mapping Logic                                                                 |
|------------------------|---------------------------------|-------------------------------------------------------------------------------|
| `t.Code`               | `ProductCode`                   | Mapped using `graniteRepository.GetMasterItemErpIdentification(t.Code)`       |
| `t.Code`               | `UPC`                           | Direct assignment from `t.Code`                                               |
| `t.ActionQty`          | `ReceivedQty`                   | Direct assignment from `ActionQty` (Summed by masteritem code)|
| `t.UOM`                | `ReceivedQtyUOM`                | Direct assignment from `t.UOM`                                                |
| N/A                    | `ReceivingConditionCode`        | Static string assignment `"00"`                                               |
| `documentDetailErpId.Split('-').Last()` |`PurchaseOrderLineId`| Mapped using `graniteRepository.GetDocumentDetailErpId(t.LineNumber, t.Document, t.Code)` |



### RETURN

- Granite Transaction: **RECEIVE**
- ISync Transaction Type: **Return Authorization Receipt Advice**

- Returns
    - XML File Name 


ReturnAuthorizationReceiptAdvice Mapping

| `Transaction` Property          | `ReturnAuthorization` Property | Mapping Logic                                                                 |
|---------------------------------|--------------------------------|-------------------------------------------------------------------------------|
| `System Settings ClientCode`          | `DepositorCode`                | Direct assignment from `System Settings ClientCode`                                |
| `transactions.FirstOrDefault().TransactionDocumentReference` | `DepositorOrderNumber`         | Direct assignment from the first transaction's `TransactionDocumentReference` |
| `DateTime.Now`                  | `ReturnDate`                   | Current date and time                                                        |
| `"Returned in Granite"`         | `Comments`                     | Static string assignment                                                     |
| `transactions.GroupBy(t => new { t.Code })` | `Items`                      | Grouped by `Code` and mapped to `ReturnAuthorizationReceiptAdviceItem`       |

ReturnAuthorizationReceiptAdviceItem Mapping

| `Transaction` Property | `ReturnAuthorizationReceiptAdviceItem` Property | Mapping Logic           |
|------------------------|--------------------------------------------------|----------------------------|
| `t.Code`               | `ProductCode`         | Mapped using `graniteRepository.GetMasterItemErpIdentification(t.Code)`       |
| `t.Code`               | `UPC`                                            | Direct assignment from `t.Code`        |
| `t.ActionQty`          | `ReturnedQty`     | Direct assignment from `ActionQty`                                  |
| `t.UOM`                | `ReturnedQtyUOM`       | Direct assignment from `t.UOM`                                    |
| N/A                    | `ReceivingConditionCode`    | Static string assignment `"00"`                          |


